<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üèÜ Ranking - Borj√£o Skins</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    /* --- SEU CSS EXISTENTE --- */
    * { margin:0; padding:0; box-sizing:border-box; }
    :root { --purple:#9431ce; --purple-glow:rgba(148,49,206,0.4);}
    body { font-family:'Rajdhani',-apple-system,sans-serif; background:#000; color:#fff; min-height:100vh; overflow-x:hidden; }

    .bg-animation { position:fixed; top:0; left:0; width:100%; height:100%; z-index:0; background:radial-gradient(circle at 50% 50%, rgba(148,49,206,0.1) 0%, transparent 50%); }
    .grid-overlay { position:fixed; top:0; left:0; width:100%; height:100%; z-index:1; background-image: linear-gradient(rgba(148,49,206,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(148,49,206,0.03) 1px, transparent 1px); background-size:50px 50px; pointer-events:none; }

    .container { position:relative; z-index:2; max-width:800px; margin:0 auto; padding:40px 20px; }

    .header { text-align:center; margin-bottom:40px; }
    .logo { width:120px; height:120px; margin:0 auto 20px; cursor:pointer; }
    .logo img { width:100%; height:100%; object-fit:contain; filter:drop-shadow(0 0 20px var(--purple-glow)); }
    .title { font-family:'Orbitron',sans-serif; font-size:48px; color:var(--purple); margin-bottom:10px; text-shadow:0 0 30px var(--purple-glow); }
    .subtitle { font-size:16px; color:rgba(255,255,255,0.6); letter-spacing:2px; }

    .ranking-header { background:linear-gradient(135deg, rgba(148,49,206,0.2), rgba(148,49,206,0.05)); border:2px solid var(--purple); border-radius:15px; padding:25px; margin-bottom:30px; text-align:center; }
    .ranking-info { display:flex; justify-content:space-around; gap:20px; flex-wrap:wrap; }
    .info-box { flex:1; min-width:150px; }
    .info-value { font-family:'Orbitron',monospace; font-size:32px; font-weight:700; color:var(--purple); margin-bottom:5px; }
    .info-label { font-size:13px; color:rgba(255,255,255,0.5); text-transform:uppercase; letter-spacing:1px; }

    .ranking-container { margin-bottom:30px; }
    .ranking-item { display:flex; align-items:center; gap:15px; background:rgba(255,255,255,0.03); border:2px solid rgba(128,128,128,0.2); border-radius:12px; padding:15px 20px; margin-bottom:12px; transition:all 0.3s ease; animation:slideIn 0.5s ease backwards; }
    .ranking-item:hover { background:rgba(148,49,206,0.1); border-color:var(--purple); transform:translateX(5px); }
    .ranking-position { font-family:'Orbitron',monospace; font-size:24px; font-weight:700; min-width:40px; text-align:center; color:var(--purple);}
    .ranking-medal { font-size:32px; min-width:40px; text-align:center; }
    .ranking-info-box { flex:1; }
    .ranking-name { font-size:20px; font-weight:600; color:white; margin-bottom:3px; }
    .ranking-numbers { font-size:14px; color:rgba(255,255,255,0.5); }
    .ranking-points { text-align:right; }
    .ranking-points-value { font-family:'Orbitron',monospace; font-size:28px; font-weight:700; color:var(--purple); }
    .ranking-points-label { font-size:11px; color:rgba(255,255,255,0.5); text-transform:uppercase; letter-spacing:1px; }

    @keyframes slideIn { from{opacity:0;transform:translateX(-20px);} to{opacity:1;transform:translateX(0);} }

    .ranking-empty { text-align:center; padding:60px 20px; color:rgba(255,255,255,0.3); }
    .ranking-empty-icon { font-size:64px; margin-bottom:20px; }

    .loading { text-align:center; padding:40px; color:rgba(255,255,255,0.5); }

    .footer { text-align:center; padding:30px 20px; color:rgba(255,255,255,0.4); font-size:13px; }
    .back-button { display:inline-block; background:linear-gradient(135deg, var(--purple), #6b1fa0); color:white; padding:12px 30px; border-radius:10px; text-decoration:none; font-weight:600; margin-top:30px; transition:all 0.3s ease; border:2px solid var(--purple);}
    .back-button:hover { transform:translateY(-2px); box-shadow:0 10px 30px var(--purple-glow); }

    /* Admin */
    .admin-btn { position:fixed; bottom:20px; right:20px; background:transparent; color:rgba(255,255,255,0.1); border:none; padding:10px; border-radius:50%; font-size:20px; cursor:pointer; transition:all 0.3s ease; z-index:999; opacity:0.15; }
    .admin-btn:hover { opacity:1; color:var(--purple); transform:rotate(90deg); background:rgba(148,49,206,0.1);}
    .admin-panel { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:1000; overflow-y:auto; padding:40px 20px;}
    .admin-panel.active { display:block; }
    .admin-container { max-width:1000px; margin:0 auto; background:rgba(20,20,20,0.95); border:2px solid var(--purple); border-radius:15px; padding:30px;}
    .admin-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; border-bottom:2px solid var(--purple); padding-bottom:20px;}
    .admin-title { font-family:'Orbitron',sans-serif; font-size:32px; color:var(--purple);}
    .close-btn { background:rgba(255,0,0,0.2); border:2px solid #ff0000; color:white; padding:8px 20px; border-radius:8px; cursor:pointer; font-weight:600; transition:all 0.3s ease;}
    .close-btn:hover { background:rgba(255,0,0,0.4); }
    .admin-table { width:100%; border-collapse:collapse; margin-top:20px;}
    .admin-table th { background:var(--purple); color:white; padding:12px; text-align:left; font-weight:600; }
    .admin-table td { padding:12px; border-bottom:1px solid rgba(148,49,206,0.2); color:white; }
    .admin-table tr:hover { background:rgba(148,49,206,0.1); }
    .admin-table input { background:rgba(255,255,255,0.1); border:1px solid var(--purple); color:white; padding:6px 10px; border-radius:5px; width:100%; }
    .btn-save { background:linear-gradient(135deg, #00cc00, #008800); border:2px solid #00cc00; color:white; padding:6px 15px; border-radius:5px; cursor:pointer; font-weight:600; margin-right:5px; }
    .btn-delete { background:linear-gradient(135deg, #ff0000, #cc0000); border:2px solid #ff0000; color:white; padding:6px 15px; border-radius:5px; cursor:pointer; font-weight:600; }
    .btn-add { background:linear-gradient(135deg, var(--purple), #6b1fa0); border:2px solid var(--purple); color:white; padding:10px 25px; border-radius:8px; cursor:pointer; font-weight:600; margin-top:20px; font-size:16px;}
    .btn-save:hover, .btn-delete:hover, .btn-add:hover { transform:translateY(-2px); box-shadow:0 5px 15px rgba(0,0,0,0.3);}
    .add-form { background:rgba(148,49,206,0.1); border:2px solid var(--purple); border-radius:10px; padding:20px; margin-bottom:20px; }
    .add-form input { background:rgba(255,255,255,0.1); border:1px solid var(--purple); color:white; padding:10px; border-radius:5px; margin-right:10px; margin-bottom:10px; }

  </style>
</head>
<body>
    <div class="bg-animation"></div>
    <div class="grid-overlay"></div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <a href="index.html" style="text-decoration: none;">
                <div class="logo">
                    <img src="images/logodb.png" alt="Logo Borj√£o Skins">
                </div>
            </a>
            <h1 class="title">üèÜ RANKING</h1>
            <p class="subtitle">RANKING GERAL DE TODOS OS TEMPOS</p>
        </div>

        <!-- Ranking Header -->
        <div class="ranking-header">
            <div class="ranking-info">
                <div class="info-box">
                    <div class="info-value" id="totalCompetitors">-</div>
                    <div class="info-label">Competidores</div>
                </div>
                <div class="info-box">
                    <div class="info-value" id="totalNumbers">-</div>
                    <div class="info-label">N√∫meros Vendidos</div>
                </div>
                <div class="info-box">
                    <div class="info-value" id="totalPoints">-</div>
                    <div class="info-label">Pontos Totais</div>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loadingMessage" class="loading">
            ‚è≥ Carregando ranking...
        </div>

        <!-- Ranking -->
        <div class="ranking-container" id="rankingContainer" style="display: none;">
            <!-- Preenchido via JavaScript -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="ranking-empty" style="display: none;">
            <div class="ranking-empty-icon">üìä</div>
            <h3 style="margin-bottom: 10px;">Nenhum comprador ainda</h3>
            <p>Seja o primeiro a aparecer no ranking!</p>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p style="margin-bottom: 15px;">‚ö° Atualizado em tempo real</p>
            <a href="rifas.html" class="back-button">‚Üê Voltar para a Rifa</a>
            <p style="margin-top: 20px; font-size: 11px;">
                ¬© 2024 Borj√£o Skins - Todos os direitos reservados
            </p>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-container">
            <div class="admin-header">
                <h2 class="admin-title">‚öôÔ∏è Painel Admin - Ranking</h2>
                <button class="close-btn" onclick="closeAdminPanel()">‚úï Fechar</button>
            </div>

            <!-- Add New Player -->
            <div class="add-form">
                <h3 style="color: var(--purple); margin-bottom: 15px;">‚ûï Adicionar Novo Jogador</h3>
                <input type="text" id="newName" placeholder="Nome completo" style="width: 200px;">
                <input type="text" id="newPhone" placeholder="Telefone (11999999999)" style="width: 150px;">
                <input type="number" id="newPoints" placeholder="Pontos" style="width: 100px;">
                <input type="number" id="newNumbers" placeholder="Cotas" style="width: 100px;">
                <button class="btn-add" onclick="addPlayer()">Adicionar</button>
            </div>

            <!-- Players Table -->
            <div style="overflow-x: auto;">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Nome</th>
                            <th>Telefone</th>
                            <th>Pontos</th>
                            <th>Cotas</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="adminTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center;">Carregando...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Bot√£o Admin Discreto -->
    <button class="admin-btn" onclick="openAdminPanel()" title="Admin">‚öôÔ∏è</button>

    <script>
        const API_BASE = '/.netlify/functions'; // Base para suas fun√ß√µes serverless

        async function loadRanking() {
            try {
                const res = await fetch(`${API_BASE}/get-ranking`);
                if (!res.ok) throw new Error('Erro ao carregar ranking');
                const ranking = await res.json();

                if (!ranking || ranking.length === 0) {
                    showEmpty('Nenhum comprador ainda. Seja o primeiro!');
                    return;
                }

                const totalCompetitors = ranking.length;
                const totalPoints = ranking.reduce((sum, r) => sum + parseFloat(r.total_points || 0), 0);
                const totalNumbers = ranking.reduce((sum, r) => sum + parseInt(r.total_numbers || 0), 0);

                document.getElementById('totalCompetitors').textContent = totalCompetitors;
                document.getElementById('totalNumbers').textContent = totalNumbers;
                document.getElementById('totalPoints').textContent = Math.round(totalPoints);

                const container = document.getElementById('rankingContainer');
                container.innerHTML = '';

                ranking.forEach((buyer, index) => {
                    const position = index + 1;
                    const medal = position === 1 ? 'ü•á' : position === 2 ? 'ü•à' : position === 3 ? 'ü•â' : '';
                    const nameParts = (buyer.buyer_name || 'An√¥nimo').split(' ');
                    const fullName = nameParts.slice(0, 2).join(' ');

                    const item = document.createElement('div');
                    item.className = 'ranking-item';
                    item.style.animationDelay = `${index * 0.1}s`;
                    if (position > 16) item.classList.add('ranking-item-inactive');

                    item.innerHTML = `
                        ${medal ? `<div class="ranking-medal">${medal}</div>` : `<div class="ranking-position">${position}¬∫</div>`}
                        <div class="ranking-info-box">
                            <div class="ranking-name">${fullName}</div>
                            <div class="ranking-numbers">${buyer.total_numbers || 0} cota(s)</div>
                        </div>
                        <div class="ranking-points">
                            <div class="ranking-points-value">${Math.round(buyer.total_points || 0)}</div>
                            <div class="ranking-points-label">pontos</div>
                        </div>
                    `;
                    container.appendChild(item);
                });

                document.getElementById('loadingMessage').style.display = 'none';
                container.style.display = 'block';
            } catch (err) {
                console.error(err);
                showEmpty('Erro ao carregar ranking. Veja o console (F12).');
            }
        }

        function showEmpty(message) {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('rankingContainer').style.display = 'none';
            const emptyState = document.getElementById('emptyState');
            emptyState.querySelector('p').textContent = message;
            emptyState.style.display = 'block';
        }

        // Atualizar a cada 10s
        loadRanking();
        setInterval(loadRanking, 10000);

        // ===== ADMIN PANEL =====
        async function openAdminPanel() {
            const password = prompt('üîê Digite a senha do administrador:');
            if (!password) return;

            const res = await fetch(`${API_BASE}/admin-login`, {
                method: 'POST',
                body: JSON.stringify({ password }),
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await res.json();
            if (!data.success) return alert('‚ùå Senha incorreta!');

            document.getElementById('adminPanel').classList.add('active');
            loadAdminData();
        }

        function closeAdminPanel() {
            document.getElementById('adminPanel').classList.remove('active');
        }

        async function loadAdminData() {
            const res = await fetch(`${API_BASE}/get-ranking`);
            const data = await res.json();
            const tbody = document.getElementById('adminTableBody');
            tbody.innerHTML = '';
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhum jogador no ranking</td></tr>';
                return;
            }
            data.forEach((player, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index+1}¬∫</td>
                    <td><input type="text" value="${player.buyer_name}" id="name_${player.id}" /></td>
                    <td><input type="text" value="${player.buyer_phone}" id="phone_${player.id}" /></td>
                    <td><input type="number" value="${Math.round(player.total_points)}" id="points_${player.id}" style="width: 80px;" /></td>
                    <td><input type="number" value="${player.total_numbers || 0}" id="numbers_${player.id}" style="width: 80px;" /></td>
                    <td>
                        <button class="btn-save" onclick="savePlayer('${player.id}')">üíæ Salvar</button>
                        <button class="btn-delete" onclick="deletePlayer('${player.id}', '${player.buyer_name}')">üóëÔ∏è Deletar</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function addPlayer() {
            const name = document.getElementById('newName').value;
            const phone = document.getElementById('newPhone').value;
            const points = parseFloat(document.getElementById('newPoints').value);
            const numbers = parseInt(document.getElementById('newNumbers').value) || 0;

            if (!name || !phone || isNaN(points)) return alert('‚ùå Preencha nome, telefone e pontos!');

            const res = await fetch(`${API_BASE}/add-player`, {
                method: 'POST',
                body: JSON.stringify({ buyer_name: name, buyer_phone: phone, total_points: points, total_numbers: numbers }),
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await res.json();
            if (!data.success) return alert('‚ùå Erro ao adicionar: ' + data.error);

            alert('‚úÖ Jogador adicionado!');
            document.getElementById('newName').value = '';
            document.getElementById('newPhone').value = '';
            document.getElementById('newPoints').value = '';
            document.getElementById('newNumbers').value = '';

            loadAdminData();
            loadRanking();
        }

        async function savePlayer(id) {
            const name = document.getElementById(`name_${id}`).value;
            const phone = document.getElementById(`phone_${id}`).value;
            const points = parseFloat(document.getElementById(`points_${id}`).value);
            const numbers = parseInt(document.getElementById(`numbers_${id}`).value);

            const res = await fetch(`${API_BASE}/update-player`, {
                method: 'POST',
                body: JSON.stringify({ id, data: { buyer_name: name, buyer_phone: phone, total_points: points, total_numbers: numbers } }),
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await res.json();
            if (!data.success) return alert('‚ùå Erro ao salvar: ' + data.error);

            alert('‚úÖ Jogador atualizado!');
            loadAdminData();
            loadRanking();
        }

        async function deletePlayer(id, name) {
            if (!confirm(`‚ùå Deletar "${name}"?`)) return;
            const res = await fetch(`${API_BASE}/delete-player`, {
                method: 'POST',
                body: JSON.stringify({ id }),
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await res.json();
            if (!data.success) return alert('‚ùå Erro ao deletar: ' + data.error);

            alert('‚úÖ Jogador deletado!');
            loadAdminData();
            loadRanking();
        }
    </script>
</body>
</html>
